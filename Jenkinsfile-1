pipeline {
  agent any
  environment {
    //once you sign up for Docker hub, use that user_id here
    registry = "hergi2004/grafana:v1.0.0"
    //- update your credentials ID after creating credentials for connecting to Docker Hub
    registryCredential = 'dockerhub_id'
    dockerImage = 'hergi2004/grafana:v1.0.0'
}
  stages {
    stage('Docker Version') {
      steps {
        sh 'docker --version'
      }
    }
    stage('Docker build grafana image') {
  steps {
    sh 'docker build -t grafana grafana/'
      }
    }
    stage('Docker tag image') {
  steps {
    sh 'docker tag  grafana hergi2004/grafana:v1.0.0'
      }
    }
     stage('Docker run image') {
  steps {
    sh 'docker run -d --rm grafana hergi2004/grafana:v1.0.0'
      }
    }
//    stage('Container Vulnerability Scanning') {
//  steps {
//    sh 'grype hergi204/grafana:v1.0.0 --scope AllLayers'
//  }
//    } 
//     stage('Container BOM with syft') {
//  steps {
//    sh 'syft hergi2004/grafana:v1.0.0 --scope all-layers'
//  }
//    } 

     // Uploading Docker images into Docker Hub
    stage('Upload Image') {
     steps{    
         script {
            docker.withRegistry( 'https://hub.docker.com', registryCredential ) {
            dockerImage.push()
            }
        }
      }
    }
    
  }
}
// Ali to fail pipeline on high vulnerabilty using grype flag fix them then push the container to the repository, adding anchore/syft to provide software BOM, see hot to present the finding may be in grafana or artifactory
// penetration testing with owasp
