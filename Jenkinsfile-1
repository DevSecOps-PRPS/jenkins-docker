pipeline {
  agent any
  stages {
    stage('Docker Version') {
      steps {
        sh 'docker --version'
      }
    }
    stage('Docker build grafana image') {
  steps {
    sh 'docker build -t grafana grafana/'
      }
    }
    stage('Docker tag image') {
  steps {
    sh 'docker tag  grafana ali0078/grafana:v1.0.0'
      }
    }
     stage('Docker run image') {
  steps {
    sh 'docker run -d --rm grafana ali0078/grafana:v1.0.0'
      }
    }
    stage('Container Vulnerability Scanning') {
  steps {
    sh 'grype ali0078/grafana:v1.0.0 --scope AllLayers'
  }
    } 
     stage('Container BOM with syft') {
  steps {
    sh 'syft ali0078/grafana:v1.0.0 --scope all-layers'
  }
    } 
     stage ('docker push image') {
   steps {
     sh 'docker push grafana ali0078/grafana:v1.0.0'

// Ali to fail pipeline on high vulnerabilty using grype flag fix them then push the container to the repository, adding anchore/syft to provide software BOM, see hot to present the finding may be in grafana or artifactory
// penetration testing with owasp
